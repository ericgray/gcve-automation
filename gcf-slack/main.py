import base64
import requests
import os

def main(event, context):
    """Triggered from a message on a Cloud Pub/Sub topic.
    Args:
         event (dict): Event payload.
         context (google.cloud.functions.Context): Metadata for the event.
    """

    webhook_url = os.environ.get('WEBHOOK_URL')
    data = base64.b64decode(event['data']).decode('utf-8')

    # Format as a block to have sections
    blocks = [
        {
            "type": "header",
            "text": {
                "type": "plain_text",
                'text': data,
            }
        },
        {
            "type": "divider"
        }
    ]
    attr_dict = event['attributes']
    if attr_dict:
        section_text = ""
        for key in attr_dict:
            value = attr_dict.get(key)
            section_text += f'*{key}:*  {value}\n'

        attribute_block = {"type": "section", "text": {"text": section_text, "type": "mrkdwn"}}
        blocks.append(attribute_block)

    # Send the message to Slack - the text field below is for fallback
    payload = {
        'text': data,
        'blocks': blocks,
    }
    headers = {
        'Content-type': 'application/json'
    }
    requests.post(webhook_url, json=payload, headers=headers)
