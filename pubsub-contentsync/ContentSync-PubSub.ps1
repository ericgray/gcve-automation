$ErrorActionPreference = 'Stop'
Import-Module ./GcveAuthentication.psm1 -Force
Import-Module ./GcveContentSync.psm1 -Force

$cred = Get-GcSecret -Name $env:CONTENTLIB_USER_SECRET -Domain $env:CONTENTLIB_USER_DOMAIN
$url = Get-GcveFqdn -PrivateCloud $env:PRIVATE_CLOUD_NAME
$subscriptionName = $env:SUBSCRIPTION_NAME
$contentLib = $env:CONTENTLIB_NAME
$slackTopic = $env:SLACK_TOPIC

Connect-VIServer -Server $url.vcenter -Credential $cred

$ackMessage = @{
    "VMware vCenter"  = "<https://$($url.vcenter)/ui/app/content-libraries|$($url.vcenter)>"
    "Content Library" = $contentLib
}

while ($true) {
    Write-Host "Waiting for messages on subscription $($subscriptionName)..."
    $pubSubResult = Get-GcpsMessage -Subscription $subscriptionName -AutoAck -MaxMessages 1
    $templateFile = $pubSubResult.Attributes.objectId
    $bucketName = $pubSubResult.Attributes.bucketId

    if ($templateFile) {
        Write-Host "Pub/Sub message received, new template: $($templateFile)"
        Sync-ContentFromBucket -Bucket $bucketName -Prefix $templateFile -ContentLibrary $contentLib
        $ackMessage['Item name'] = $templateFile
        $ackMessage['Storage Bucket'] = $bucketName
        Publish-GcpsMessage -Topic $slackTopic -Data ":notice-arrow: Content Library Notification" `
            -Attributes $ackMessage | Out-Null
    }
    else {
        Write-Host "No new template objects published."
        Start-Sleep -Seconds 2
    }
}
