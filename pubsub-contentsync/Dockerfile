FROM gcr.io/google.com/cloudsdktool/google-cloud-cli:slim

RUN curl -s https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /usr/share/keyrings/microsoft-archive-keyring.gpg
RUN sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-archive-keyring.gpg] https://packages.microsoft.com/repos/microsoft-debian-bullseye-prod bullseye main" > /etc/apt/sources.list.d/microsoft.list'
RUN apt-get update && apt-get install -y powershell

RUN addgroup --system app && adduser --system --group app
WORKDIR /app
RUN chown -R app:app /app
USER app

RUN pwsh -noni -Command Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted
RUN pwsh -noni -Command Install-Module VMware.PowerCLI -Scope CurrentUser
RUN pwsh -noni -Command Set-PowerCLIConfiguration -Scope User -ParticipateInCEIP:\$false -Confirm:\$false
RUN pwsh -noni -Command Install-Module GoogleCloud -Scope CurrentUser

COPY --chown=app ./GcveAuthentication.psm1 .
COPY --chown=app ./GcveContentSync.psm1 .
COPY --chown=app ./ContentSync-PubSub.ps1 .

CMD ["pwsh", "-noni", "ContentSync-PubSub.ps1"]
