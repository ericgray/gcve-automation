# Automatic Content Sync via Google Cloud Pub/Sub

The PowerCLI script in this directory monitors a Pub/Sub subscription so that when a new OVA or ISO object is copied to a Cloud Storage bucket it will be copied to a VMware Content Library.

The script then posts a message to Slack using another Pub/Sub topic and a Google Cloud Function. See [gcf-slack](../gcf-slack/README.md) for setup details.

Run it from command line, container, or systemd. Configure specifics with [environment variables](contentsync.env).

## Cloud Storage and Pub/Sub Setup

Create a Pub/Sub topic [notification](https://cloud.google.com/storage/docs/pubsub-notifications) for your Cloud Storage bucket via `gcloud`:

```bash
gcloud storage buckets notifications create gs://my-content-bucket \
--topic=content-updates --event-types=OBJECT_FINALIZE

gcloud pubsub subscriptions create content-updates-sub \
--topic=content-updates \
--expiration-period=never
```

## VMware Content Library Credentials

On the Google Cloud VMware Engine private cloud, log into vCenter with elevated priviliges and create a new user account with adequate permissions to upload to the Content Library. Store this password in [Google Cloud Secret Manger](https://cloud.google.com/secret-manager). Specify the name of the secret in the corresponding environment variable.

This script will fetch the credentials at startup in order to authenticate.

_This example was used during a breakout session demo at VMware Explore 2023: CEIB2548LV Supercharge Google Cloud VMware Engine Infrastructure with Native Services_
