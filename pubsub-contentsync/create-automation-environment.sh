#!/usr/bin/env bash

# Simple script to quickly create a service account with specified IAM roles.
# Also launches a GCE VM instance that uses the new service account
# Default values below can be overridden with environment variables as needed.

idnum=$RANDOM

SVC_ACCT_NAME=${SVC_ACCT_NAME:-supercharge${idnum}}
NEW_INSTANCE=${NEW_INSTANCE:-explore${idnum}}
ZONE=${ZONE:-$(gcloud config get compute/zone)}
PROJECT_ID=${PROJECT_ID:-$(gcloud config get project)}
MACHINE_TYPE=${MACHINE_TYPE:-e2-micro}

IAM_ROLES=${IAM_ROLES:-"
compute.admin
compute.networkViewer
dns.admin
pubsub.admin
secretmanager.secretAccessor
serviceusage.serviceUsageAdmin
storage.admin
vmwareengine.vmwareengineAdmin
"}

gcloud iam service-accounts create "$SVC_ACCT_NAME" --format=json

svc_acct="${SVC_ACCT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"

for i in $IAM_ROLES ; do
	gcloud projects add-iam-policy-binding $PROJECT_ID \
		--member="serviceAccount:${svc_acct}" --role="roles/${i}" 1>/dev/null
done


subnet=$(gcloud compute networks subnets list \
	--regions="${ZONE%-a}" --format="value(selfLink.basename())")

gcloud compute instances create "$NEW_INSTANCE" \
	--zone="$ZONE" --subnet="$subnet" \
	--machine-type=$MACHINE_TYPE \
	--image-project=ubuntu-os-cloud --image-family=ubuntu-2204-lts \
	--scopes=cloud-platform --service-account="$svc_acct"

